<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Tasks</title> 
    <style>
    
    #task_parameters {
        display:none;
        position: absolute;
        left: 300px;
        width: 400px;
        top: 0;
    }

    .selected {
        border: 1px solid gray;
    }

    #type div, #task div  {
        display: inline-block;

    }
    
    </style>
 
  
</head>
<body>
    
    <div id="tasks">
        <div id="new_task">+ NEW TASK</div> 
        <div id="created_tasks">
    </div>
    <div id="task_parameters">
        <div id = 'summary_block'>
            <p>TASK SUMMARY</p>
            <div id="summary"></div>
            <div id="submit"></div>
        </div>
        <div >
            <p>TASK LOCTION</p>
            <input type = 'text' id = 'location'></input>
        </div>
        <div id = "type">
            <p>SERVICE TYPE</p>
        </div>
        <div id = "task">
            <p></p>
        </div>
        <div> 
            <p>TASK DESCRIPTION</p>
            <input type = 'text' id = 'description'></input>
        </div>        
    </div>





    <script>

            var taskTypes = [
                {
                    type: 'Electrician',
                    tasks: ['Fix light', 'Fix something else']
                },
                {
                    type: 'Plumber',
                    tasks: ['Unlock a toilet', 'Unlock a sink', 'Fix water leak']
                },
                {
                    type: 'Housekeeper',
                    tasks: ['Iron closes', 'Clean bathroom', 'Cook dinner']
                }
            ]
            
            
            function getTasks() {
                let xhr = new XMLHttpRequest();
                xhr.open('GET', 'http://localhost:3333/alltasks', true) ;
                xhr.onload = function(){
                    var createdTasks = JSON.parse(this.response);   
                    reflectCreatedTasks(createdTasks);                             
                }
                xhr.send();
            }
      
          function reflectCreatedTasks(createdTasks){
            var createdTasksDivs = new Array;;                    
                var createdTasksBlock = document.getElementById('created_tasks');                

                for (i in createdTasks){                       
                    createdTasksDivs[i] = document.createElement('div'); 
                    let taskDate = parseDate(createdTasks[i].id);                          
                    let text = `<div id=${createdTasks[i].id} class="created_task"><div class='date'>${taskDate}</div><div class='description'>${createdTasks[i].description}</div><div class='buttons'><button>Edit</button><button>Delete</button></div></div>`; 
                    createdTasksDivs[i].innerHTML = text;                        
                    createdTasksBlock.append(createdTasksDivs[i]);                      
                }      
          }
      
             //!!!!!!
            function addActionToButtons(){
             document.getElementByClassName("create_task").querySelector('button:contains("Delete")').addEventListener('click', deleteTask, false); 
             document.getElementByClassName("create_task").querySelector('button:contains("Edit")').addEventListener('click', showTaskProperties, false);
             
              function deleteTask(e){
              var element = e.currentTarget.parentNode().id;  
              let xhr = new XMLHttpRequest();
                xhr.open('DELETE', `http://localhost:3333/${element}`, true) ;
                xhr.onload = function(){
                  //reload page
              }
              xhr.send(); 
              
             }
              
              function showTaskProperties(){
                
              }
            }
      
      //!!!!  Also reload page after modifications with tasks
      

      
      
      
      
      
            function parseDate(dateString){
             let dateAsDate = new Date(Number(dateString));  
             let months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'Augest', 'September', 'October', 'November', 'December'];
             let days = ['Sunday', 'Monday', 'Tuesday', 'Wednesay', 'Thursday', 'Friday', 'Saturday'];
             let month = months[dateAsDate.getMonth()];
             let day = days[dateAsDate.getDay()];
             let monthDay = dateAsDate.getDate();
             let hours = dateAsDate.getHours() < 10 ? '0' + dateAsDate.getHours() : dateAsDate.getHours();
             let minutes = dateAsDate.getMinutes() < 10 ? '0' + dateAsDate.getMinutes() : dateAsDate.getMinutes();
             let seconds = dateAsDate.getSeconds() < 10 ? '0' + dateAsDate.getSeconds() : dateAsDate.getSeconds();  
             return `${day},${month} ${monthDay}, ${hours}:${minutes}`;
            }


            function createTask() {
                var taskType;
                var taskSubtype;
                var taskDescription;
                var taskLocation;
               
               let newTaskButton =  document.getElementById('new_task'); 
               newTaskButton.addEventListener('click', showNewTaskOptions, false);

               function showNewTaskOptions(e) {
                   e.preventDefault();
                    document.getElementById('task_parameters').style.display = 'block';
                    let taskOptions = document.getElementById('type');
                    var taskTypeDivs = new Array;
                    for (let i in taskTypes) {
                        taskTypeDivs[i] = document.createElement('div');
                        taskTypeDivs[i].innerHTML = taskTypes[i].type;
                        taskTypeDivs[i].addEventListener('click', selectType, true);
                        taskOptions.append(taskTypeDivs[i]);    
                    }                

                    function selectType(e) {
                        e.preventDefault();
                        taskType = e.currentTarget.innerText;
                        document.getElementsByClassName('selected').className.remove('selected');
                        e.currentTarget.setAttribute('class','selected');
                        document.getElementById('summary').innerText = getTaskSummary();
                        showSubtypes(taskType);
                    } 

                    function showSubtypes(selectedType){
                        var subTypesDiv = document.getElementById('task');
                        subTypesDiv.innerHTML = '';
                        let title = document.createElement('p');
                        subTypesDiv.append(title);
                        title.innerText = `${taskType.toUpperCase()} TASKS`;
                        var selectedSubtypes = taskTypes.find(task => task.type === selectedType);
                        var subTypesDivs = new Array;
                        
                        for (let i in selectedSubtypes.tasks) {
                            subTypesDivs[i] = document.createElement('div');
                            subTypesDivs[i].innerHTML =  selectedSubtypes.tasks[i];
                            subTypesDivs[i].addEventListener('click', selectSubType, true);
                            subTypesDiv.append(subTypesDivs[i]); 
                        }
                    }

                    function selectSubType(e) {
                        e.preventDefault();
                        taskSubtype = e.currentTarget.innerText;
                        // Select only subtype fix document.getElementsByClassName('selected').querySelector('').className.remove('selected');
                        e.currentTarget.setAttribute('class','selected'); 
                        document.getElementById('summary').innerText = getTaskSummary();                       
                    }
                

                }

                function getTaskSummary(){
                    taskDescription = document.getElementById('description').value;                    
                    return `I need a ${taskType} to ${taskSubtype}, ${taskDescription}.`;
                }

                document.getElementById('description').addEventListener('change', (e) => {
                    taskDescription = document.getElementById('description').value;
                    document.getElementById('summary').innerText = getTaskSummary();
                }, false);


                var createTaskButton =  document.getElementById('submit'); 
                
                console.log(createTaskButton);

                createTaskButton.innerText = 'CREATE TASK';

                function newTask (location, type, subType, description) {
                    this.id = Date.now().toString();
                    this.location = location;
                    this.type = type;
                    this.subType = subType;
                    this.description = description;
                 }
                
                    
                function addTask(e){
                    e.preventDefault();
                    taskLocation = document.getElementById('location').value; 
                    var task= new newTask(taskLocation, taskType, taskSubtype, taskDescription);
                    console.log(JSON.stringify(task));

                    let xhr = new XMLHttpRequest();
                    xhr.open('POST', 'http://localhost:3333/tasks', true) ;
                   xhr.onload = function(){                    
                    }
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.send(JSON.stringify(task));                 
                }

                createTaskButton.addEventListener('click',addTask, false);


                

            }

            

            

            
            getTasks();
            createTask();
            
            
              </script>

    
</body>
</html>
