<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Tasks</title> 
  <script src = "./getTasks.js"></script>
 
    <style>
    
    #task_parameters {
        display:none;
        position: absolute;
        left: 300px;
        width: 400px;
        top: 0;
    }

    .selected_type, .selected_task {
        border: 1px solid gray;
        border-radius: 15px;
    }

    #type div, #task div  {
        display: inline-block;

    }
    
    </style>
 
  
</head>
<body>
    
    <div id="tasks">
        <div id="new_task">+ NEW TASK</div> 
        <div id="created_tasks">
    </div>
    <div id="task_parameters">
        <div id = 'summary_block'>
            <p>TASK SUMMARY</p>
            <div id="summary"></div>
            <div id="submit"></div>
        </div>
        <div >
            <p>TASK LOCTION</p>
            <input type = 'text' id = 'location'></input>
        </div>
        <div id = "type">
            <p>SERVICE TYPE</p>
        </div>
        <div id = "task">
            <p></p>
        </div>
        <div> 
            <p>TASK DESCRIPTION</p>
            <input type = 'text' id = 'description'></input>
        </div>        
    </div>
   
            
            
             
    
   <script>
     var taskTypes = [
        {
            type: 'Electrician',
            tasks: ['Fix light', 'Fix something else']
        },
        {
            type: 'Plumber',
            tasks: ['Unlock a toilet', 'Unlock a sink', 'Fix water leak']
        },
        {
            type: 'Housekeeper',
            tasks: ['Iron closes', 'Clean bathroom', 'Cook dinner']
        }
    ];
    
    
    function getTasks() {
        let xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://localhost:3333/alltasks', true) ;
        xhr.onload = function(){
            var createdTasks = JSON.parse(this.response);   
            reflectCreatedTasks(createdTasks);                             
        }
        xhr.send();
    }
    
    function reflectCreatedTasks(createdTasks){
        
        var createdTasksDivs = new Array;                    
        var createdTasksBlock = document.getElementById('created_tasks'); 
      
        let newTaskButton =  document.getElementById('new_task'); 
        var reflectNewTask;
        //console.log();
        function openNewTaskOptions(){
            editTaskList();
        }
        newTaskButton.addEventListener('click', openNewTaskOptions, false);
        
        function deleteTask(e){                      
            let element = e.currentTarget;                    
            let id = element.parentNode.parentNode.id;                     
            let xhr = new XMLHttpRequest();
                xhr.open('DELETE', `http://localhost:3333/${id}`, true) ;
                xhr.onload = function(){
                location.reload(true);                         
            }
            xhr.send();                     
        }    
        
        function editTask(e){                      
              let element = e.currentTarget;                      
              let id = element.parentNode.parentNode.id;                       
              let xhr = new XMLHttpRequest();
              
                xhr.open('GET', `http://localhost:3333/${id}`, true) ;
                xhr.onload = function(){
                  var taskToEdit = JSON.parse(this.response);
                  editTaskList(taskToEdit) ; 
              }
              xhr.send();               
          }     
    
        for (i in createdTasks){                       
            createdTasksDivs[i] = document.createElement('div'); 
            let taskDate = parseDate(createdTasks[i].id);  
            createdTasksDivs[i].id=createdTasks[i].id;
            createdTasksDivs[i].className = ('created_task');
            createdTasksBlock.append(createdTasksDivs[i]); 
            
            let dateDiv = document.createElement('div');
            dateDiv.className = ('date');
            dateDiv.innerText = taskDate;
            createdTasksDivs[i].append(dateDiv);
    
            let descriptionDiv = document.createElement('div');
            descriptionDiv.className = ('description');
            descriptionDiv.innerText = createdTasks[i].description;
            createdTasksDivs[i].append(descriptionDiv);
    
            let buttonsDiv = document.createElement('div');
            buttonsDiv.className = ('buttons');
            createdTasksDivs[i].append(buttonsDiv);
    
            let deleteButton = document.createElement('button');
            deleteButton.innerText = 'Delete';
            buttonsDiv.append(deleteButton);
            deleteButton.addEventListener('click', deleteTask, false);
    
            let editButton = document.createElement('button');
            editButton.innerText = 'Edit';
            buttonsDiv.append(editButton);  
            editButton.addEventListener('click', editTask, false);             
        }      
    }    
    
    function parseDate(dateString){
     let dateAsDate = new Date(Number(dateString));  
     let months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'Augest', 'September', 'October', 'November', 'December'];
     let days = ['Sunday', 'Monday', 'Tuesday', 'Wednesay', 'Thursday', 'Friday', 'Saturday'];
     let month = months[dateAsDate.getMonth()];
     let day = days[dateAsDate.getDay()];
     let monthDay = dateAsDate.getDate();
     let hours = dateAsDate.getHours() < 10 ? '0' + dateAsDate.getHours() : dateAsDate.getHours();
     let minutes = dateAsDate.getMinutes() < 10 ? '0' + dateAsDate.getMinutes() : dateAsDate.getMinutes();
     let seconds = dateAsDate.getSeconds() < 10 ? '0' + dateAsDate.getSeconds() : dateAsDate.getSeconds();  
     return `${day},${month} ${monthDay}, ${hours}:${minutes}`;
    }
    
    
    function editTaskList(task) {
        console.log(arguments);
        var taskType;
        var taskSubtype;
        var taskDescription;
        var taskLocation;
        
        function setTaskSummary(descr){
            if(arguments.length == 0) {
                descr = document.getElementById('description').value;
            }                    
            document.getElementById('summary').value = `I need a ${taskType} to ${taskSubtype}, ${descr}.`;
        }

        function reflectExistingTaskOptions(taskType, taskLocation, taskSubtype, taskDescription) {     
            showTaskOptions();
            showSubtypes(taskType);

            let types = document.getElementById('type').childNodes;
            for (let i in types){
                if (types[i].innerHTML == taskType){
                    types[i].setAttribute('class', 'selected_type');
                }
            }

            let tasks = document.getElementById('task').childNodes;            
            for (let i in tasks){
                if (tasks[i].innerHTML == taskSubtype){
                    tasks[i].setAttribute('class', 'selected_task');
                }
            }

            document.getElementById('location').value = taskLocation;
            document.getElementById('description').value = taskDescription; 
            setTaskSummary(taskDescription);
        }

        

        if (arguments.length !== 0) {
            
            var selecetedTask = arguments[0];
            console.log(task);
            taskType = task.type;
            taskLocation = task.location;
            taskSubtype = task.subType;            
            taskDescription = task.description;

            reflectExistingTaskOptions(taskType, taskLocation, taskSubtype, taskDescription); 
            getTaskSummary(taskDescription);      
        


       }  else {
            showTaskOptions();

       }

       
       

       //let newTaskButton =  document.getElementById('new_task'); 
       //newTaskButton.addEventListener('click', showNewTaskOptions, false);
        

    
       function showTaskOptions() {          
            document.getElementById('task_parameters').style.display = 'block';
            let taskOptions = document.getElementById('type');
            var taskTypeDivs = new Array;
            for (let i in taskTypes) {
                taskTypeDivs[i] = document.createElement('div');
                taskTypeDivs[i].innerHTML = taskTypes[i].type;
                taskTypeDivs[i].addEventListener('click', selectType, true);
                taskOptions.append(taskTypeDivs[i]);    
            }                
        }

            function selectType(e) {
                e.preventDefault();                     

                if (taskType !== undefined) {
                    let currentSelected = document.getElementsByClassName('selected_type');                        
                    currentSelected.classList.remove('selected_type');
                }
                taskType = e.currentTarget.innerText;
                e.currentTarget.setAttribute('class','selected_type');
                document.getElementById('summary').innerText = getTaskSummary();
                showSubtypes(taskType);
            }
    
            function showSubtypes(selectedType){
                var subTypesDiv = document.getElementById('task');
                subTypesDiv.innerHTML = '';
                let title = document.createElement('p');
                subTypesDiv.append(title);
                title.innerText = `${taskType.toUpperCase()} TASKS`;
                var selectedSubtypes = taskTypes.find(task => task.type === selectedType);
                var subTypesDivs = new Array;
                
                for (let i in selectedSubtypes.tasks) {
                    subTypesDivs[i] = document.createElement('div');
                    subTypesDivs[i].innerHTML =  selectedSubtypes.tasks[i];
                    subTypesDivs[i].addEventListener('click', selectSubType, true);
                    subTypesDiv.append(subTypesDivs[i]); 
                }
            }    
            

            function selectSubType(e) {
                e.preventDefault();
                if (taskSubtype !== undefined) {
                let selectedTask = document.getElementsByClassName('selected_task');
                currentSelected.classList.remove('selected_task');
                }
                taskSubtype = e.currentTarget.innerText;                        
                e.currentTarget.setAttribute('class','selected_task'); 
                document.getElementById('summary').innerText = getTaskSummary();                       
            }     
        
    
            
    
            document.getElementById('description').addEventListener('change', (e) => {
                taskDescription = document.getElementById('description').value;
                document.getElementById('summary').innerText = getTaskSummary();
            }, false);
        
    
        var createTaskButton =  document.getElementById('submit');      
    
        createTaskButton.innerText = 'CREATE TASK';
    
        function newTask (location, type, subType, description) {
            this.id = Date.now().toString();
            this.location = location;
            this.type = type;
            this.subType = subType;
            this.description = description;
         }
            
        function addTask(e){
            e.preventDefault();
            taskLocation = document.getElementById('location').value; 
            var task= new newTask(taskLocation, taskType, taskSubtype, taskDescription);
            console.log(JSON.stringify(task));
    
            let xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://localhost:3333/tasks', true) ;
           xhr.onload = function(){                    
            }
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(task));  
            location.reload(true);               
        }
    
        createTaskButton.addEventListener('click',addTask, false); 
    }
     




    getTasks();
    //editTaskList(); ///Should be put to event listener of the new task
  </script> 
</body>
</html>
